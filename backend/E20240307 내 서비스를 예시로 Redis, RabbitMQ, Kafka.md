### 내 서비스를 예시로 Redis, RabbitMQ, Kafka
일단 MSA 잘 모른다.     
그저 머릿 속 정리니 혹시 누군가 이 글을 본다면 무시하시길.     

### Redis, RabbitMQ, Kafka?
0. 일단 MSA라고 가정하자. 사실 아니지만 음 서비스 별로 배포 방식, HPA, 기술 스택을 달리하고 재난 범위를 최소화하고 싶었나보다.
0. 이벤트 기반 아키텍쳐를 쓴다고 가정하자. 이건 음 서비간 직접 통신은 의존이 크고, 재시도 처리, 비동기 처리에 편하니까라고.
1. 회원 가입을 하면 스토리지 사용량 이벤트가 발행되고 사용량 정보가 초기화된다.
- 신뢰성이 필요한가? : 반드시 되어야 한다. 혹시 처리 중 실패를 한다면 재시도 처리를 적극적으로 해야한다.
- 이벤트 내용이 영속되어야 하는가? : 지금 요구 사항으로는 그렇지 않다. 당장은 영속도 필요없고 서버간 관계도 1:1이다.
- RabbitMQ를 쓰겠다. 
2. 스토리지 구매가 일어나면 유저 서비스에서 이력 기록 업데이트, 스토리지 서비스에서 사용 공간 제한을 늘려야한다.
- 신뢰성이 필요한가? : 반드시 되어야 한다.
- 이벤트 내용이 영속되어야 하는가? : 여러 서비스에 따로 채널/큐를 만드는게 아니라면
- Kafka 를 쓰겠다.
- 이벤트 순서 보장을 위해 유저 id를 partition 키로 하겠다. => 예를 들어 구매와 취소가 순서대로 요청되었는데 파티션이 달라 취소 -> 구매라면 큰일일테니
- consumer group 을 유저 서비스와 스토리지 서비스가 다르게 설정해야겠다 => 그래야 같은 이벤트에 둘 다 가져갈테니까
3. WAS 간 데이터 공유가 필요하다.
- DB나 레디스
- 집계나 조회 캐시를 위한 임시 데이터라면 레디스
- 영속과 ACID에 더 큰 초점을 두었다면 DB
4. 동시성 처리를 위한 락 구현이 필요하다.
- 단일 WAS라면 synchronized나 vilotile, 메모리를 사용하겠다.
- 분산 환경이라면 DB는 네임드 락, Redis 는 pub/sub을 써도 좋겠다.
- 이벤트 영속도 필요없고, 신뢰성도 그렇게 중요하지 않다.
- 혹 처리 중 문제가 생기면 lock 을 풀거나 예외 처리도 못한다면 ttl 이 있으니 consumer에서 재시도 하면 그만일테니까.

### 파일 다중 삭제
그냥 나 혼자 고민

1. 앨범 삭제 요청이 들어오면 앨범의 사진 정보 확인 -> 메시지큐에 제거할 사진들 넣기 -> DB에서 앨범 정보 제거로 처리한다.
2. 사용자가 사진 제거 시간을 굳이 기다리지 않아도 되고, 사진 파일의 삭제는 사용자의 책임에서 벗어난다고 생각했다.
3. (사진 파일 삭제가 사용자의 앨범 삭제 요청 실패로 이어지지 않음 / 그래서 비동기로 처리했다.)
4. 사진 파일 처리기를 메인 서버와 다른 프로세스로 하고 싶었다.
5. HPA를 메인 서버는 사용자 요청량, 사진 파일 처리는 파일 처리량으로 둘을 독립적으로 할 수 있고
6. 개발 기술을 아예 다르게 잡을 수도 있고
7. 둘의 역할이 완전히 독립적이라고 생각했고
8. 만약 파일 처리에 문제가 생기면 서킷브레이커로 사진 파일 처리만 막으면 메인 서버는 최소한의 기능으로 살아있을 수 있으테니 재난을 좁힐 수도 있겠다.
9. 요청과 DB 처리가 한 트랜잭션 안에 있는데 원자성 보장이 안된다.
10. 예를 들면 DB 조회 -> 이벤트 발행 -> DB 제거 중 제거에서 문제가 발행한다면 DB는 롤백 되지만 이벤트 발행은 롤백 될 수 없으니.
11. outbox 패턴으로 이벤트 발행 내역도 DB에 우선 저장하고 스케줄러로 이를 주기적으로 비워주는 식으로 원자성을 보장했다.
12. 만약 처리 중 문제가 발생한다면 MQ의 재시도 처리가 먼저 돌고 그래도 안된다면 DeadLetter 로 처리되어 개발자에게 이를 알린다.
13. MQ의 재시도 처리 header에 DeadLetter 시 라우팅 방법을 지정하는 것으로 DeadLetter queue로 전달한다.
14. 분산환경에서 단일 스케줄링을 위해 lock 을 사용했다.
